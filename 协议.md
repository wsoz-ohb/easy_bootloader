# Easy Bootloader 通信协议文档

## 1. 概述

本文档定义了 Easy Bootloader 通用框架的串口通信协议，包括 Bootloader 刷写协议和 APP 运行时协议。

- **物理层**: UART, 115200-8-N-1, DMA + 空闲中断
- **字节序**: 大端序 (Big-Endian)

## 2. 通用帧格式

```
┌────────┬────────────┬────────┐
│ 包头   │  Payload   │ 包尾   │
│ 2B     │  nB        │ 2B     │
│0x55 0xAA│           │0x55 0x55│
└────────┴────────────┴────────┘
```

## 3. Bootloader 刷写协议

### 3.1 数据帧格式

用于传输固件数据，最大 1024 字节/包。

```
┌────────┬────────────┬────────────┬──────────┬──────────┬────────┐
│ 包头   │ 剩余字节   │ 本包长度   │ 数据     │ 校验和   │ 包尾   │
│ 2B     │ 3B         │ 2B         │ ≤1013B   │ 2B       │ 2B     │
│0x55 0xAA│            │            │          │          │0x55 0x55│
└────────┴────────────┴────────────┴──────────┴──────────┴────────┘
```

| 字段 | 长度 | 说明 |
|------|------|------|
| 包头 | 2B | 固定 `0x55 0xAA` |
| 剩余字节 | 3B | 当前帧之后仍需传输的字节数，大端序，最后一包为 0 |
| 本包长度 | 2B | 数据区字节数，大端序，最大 1013 |
| 数据区 | ≤1013B | 固件原始字节流 |
| 校验和 | 2B | (本包长度 + 数据区) 逐字节累加，大端序 |
| 包尾 | 2B | 固定 `0x55 0x55` |

### 3.2 ACK 应答帧

Bootloader 每成功写入一帧后回传：

```
0x55 0xAA 0xFF 0xFE 0x55 0x55 (6字节)
```

## 4. APP 运行时协议

### 4.1 查询版本命令

**请求** (6字节):
```
0x55 0xAA 0xFF 0xDD 0x55 0x55
```

**响应**: 串口返回 `version:xx\r\n`

### 4.2 查询更新时间命令

**请求** (6字节):
```
0x55 0xAA 0xFF 0xCC 0x55 0x55
```

**响应**: 串口返回 `YYYY-MM-DD\r\n` (如 `2025-12-01\r\n`)

### 4.3 触发升级命令

**请求** (14字节):
```
┌────────┬────────────┬────────────┬────────┬────────┐
│ 包头   │ 版本号     │ 更新时间   │ 命令码 │ 包尾   │
│ 2B     │ 4B         │ 4B         │ 2B     │ 2B     │
│0x55 0xAA│            │            │0xFF 0xEE│0x55 0x55│
└────────┴────────────┴────────────┴────────┴────────┘
```

| 字段 | 偏移 | 长度 | 说明 |
|------|------|------|------|
| 包头 | 0 | 2B | 固定 `0x55 0xAA` |
| 版本号 | 2 | 4B | uint32_t, 大端序 |
| 更新时间 | 6 | 4B | uint32_t, 格式 `0xYYYYMMDD` (如 `0x20251201` = 2025年12月1日) |
| 命令码 | 10 | 2B | 固定 `0xFF 0xEE` |
| 包尾 | 12 | 2B | 固定 `0x55 0x55` |

**示例**: 版本号 `0x00000001`, 更新时间 `2025-12-01`
```
55 AA 00 00 00 01 20 25 12 01 FF EE 55 55
```

**响应**:
- 版本号不同: 发送 ACK `0x55 0xAA 0xFF 0xFE 0x55 0x55`，然后写入标志位并复位
- 版本号相同: 串口返回 "Version is same, don't need to update"

## 5. 标志位区定义

标志位区地址由 `boot_config.h` 中的 `BOOT_FLAG_REGION_ADDR` 定义。

| 偏移 | 字段 | 大小 | 说明 |
|------|------|------|------|
| 0x00 | bootloader_flag | 4B | 启动标志 |
| 0x04 | app_version | 4B | 应用版本号 |
| 0x08 | update_date | 4B | 更新时间 `0xYYYYMMDD` |

### 5.1 bootloader_flag 值定义

| 值 | 含义 |
|------|------|
| 1 | Bootloader 模式，等待固件刷写 |
| 2 | APP 模式，跳转到应用程序 |
| 0xFFFFFFFF | 未初始化（Flash 擦除后默认值） |

## 6. 升级流程

```
┌─────────┐     ┌─────────┐     ┌─────────────┐
│ 上位机  │     │   APP   │     │ Bootloader  │
└────┬────┘     └────┬────┘     └──────┬──────┘
     │               │                  │
     │ 触发升级命令  │                  │
     │──────────────>│                  │
     │               │                  │
     │               │ 比较版本号       │
     │               │                  │
     │     ACK       │                  │
     │<──────────────│                  │
     │               │                  │
     │               │ 写入版本号       │
     │               │ 写入更新时间     │
     │               │ 写入 flag=1      │
     │               │ 系统复位         │
     │               │                  │
     │               │                  │
     │               └──────────────────>│
     │                                   │
     │                                   │ 检测 flag=1
     │                                   │ 进入刷写模式
     │                                   │
     │         固件数据包                │
     │──────────────────────────────────>│
     │              ACK                  │
     │<──────────────────────────────────│
     │              ...                  │
     │         最后一包 (剩余=0)         │
     │──────────────────────────────────>│
     │              ACK                  │
     │<──────────────────────────────────│
     │                                   │
     │                                   │ 写入 flag=2
     │                                   │ 跳转到 APP
     │                                   │
```

## 7. 命令码汇总

| 命令 | 特征字节 | 帧长度 | 方向 |
|------|----------|--------|------|
| 查询版本 | `0xFF 0xDD` | 6B | 上位机 → APP |
| 查询更新时间 | `0xFF 0xCC` | 6B | 上位机 → APP |
| 触发升级 | `0xFF 0xEE` | 14B | 上位机 → APP |
| ACK 应答 | `0xFF 0xFE` | 6B | 设备 → 上位机 |
